---
title: TCP 三次握手发生在 socket 建立的哪一步？
category: 网络协议
date: 2025-07-09 20:11
difficulty: 困难
excerpt: TCP 三次握手在客户端调用 connect () 函数时触发，在建立 socket 连接的过程中确保连接可靠建立。
tags:
- TCP
- socket
- TCP/IP
---
TCP 三次握手发生在 socket 编程中客户端调用 `connect()` 操作期间，具体包括从客户端初始连接尝试到完成确认的过程。它在网络层面确保连接可靠建立，并发生在操作系统协议栈初始化 socket 连接数据的阶段。

以下是详细解释：
1. **TCP 三次握手的定义**：TCP 三次握手是一个标准协议过程，旨在在客户端和服务器之间建立可靠连接。
   - 第一次握手：客户端向服务器发送一个 `SYN`（同步）报文，请求初始连接。
   - 第二次握手：服务器在接收到 `SYN` 后，回应一个 `SYN-ACK`（同步-确认）报文。
   - 第三次握手：客户端发送 `ACK`（确认）报文作为响应，最终确认连接建立。

2. **与 socket 编程的关系**：
   - 在 socket API 中，建立连接的过程涉及函数调用序列，例如：
     ```markdown
     // 服务器端初始化步骤，进入监听状态
     socket() -> bind() -> listen(); // 服务器准备接收连接
     ```
     ```markdown
     // 客户端开始连接过程（触发握手）
     socket();        // 创建 socket 描述符
     connect();       // 执行后启动三次握手：发送 SYN 等步骤
     ```
   - 具体到 `connect()`：当客户端调用该方法时：
     - **触发点**：`connect()` 操作立即引发网络层执行第一次握手（发送 `SYN` 报文）。
     - **进程间**：服务器在 `listen()` 下处于等待状态；一旦接收到客户端的 `SYN`，服务器在内部处理第二次握手（响应 `SYN-ACK`），无需程序显式调用额外函数。
     - **完成阶段**：当客户端通过操作系统处理服务器的 `SYN-ACK` 并发出第三次握手的 `ACK` 后，`connect()` 成功返回（通常在几十毫秒内）。这时，连接进入 `ESTABLISHED` 状态（如服务器在 accept() 中准备接受）。

3. **为何发生此步？**
   - 这确保了 socket 连接可靠性：通过三次协商双方通讯能力（如客户端发送 SYN -> 服务器确认接收能力 -> 客户端确认服务响应能力）。
   - 实践中，如错误处理：如果在 `connect()` 中握手失败（如网络超时），API 会返回失败错误以提示开发者重试。

总之，在 socket 建立生命周期，三次握手起始于客户端 `connect()` 并结束于协议栈内部完整过程，实现底层 TCP 通道准备就绪。
